# 开发日志

## 2026-02-21 深色模式功能实现

### 功能描述
- 实现了深色模式切换功能，用户可以通过页面左上角的切换按钮在浅色模式和深色模式之间自由切换
- 切换按钮会根据当前模式显示不同的图标（太阳图标表示浅色模式，月亮图标表示深色模式）
- 所有页面元素都支持深色模式，包括背景、文字、边框等
- 命盘宫位的边框样式也会根据深色模式自动调整（浅色模式为黑色边框，深色模式为白色边框）

### 技术实现
1. **更新 Tailwind CSS 配置**：
   - 在 `tailwind.config.js` 文件中添加了 `darkMode: 'class'` 配置，以支持通过类名切换深色模式

2. **实现切换功能**：
   - 在 `page.tsx` 文件中实现了 `toggleDarkMode` 函数
   - 函数通过操作 `document.documentElement.classList` 来添加或移除 'dark' 类
   - 同时更新 `darkMode` 状态，以确保切换按钮的图标正确显示

3. **样式调整**：
   - 为所有页面元素添加了 `dark:` 前缀的 Tailwind 类，以定义深色模式下的样式
   - 调整了命盘宫位的边框样式，确保在深色模式下清晰可见
   - 为深色模式下的命盘宫位添加了浅灰色背景（#333333），以提高文字的可读性
   - 确保深色模式下的文字颜色为白色，与背景形成良好对比

4. **后续优化**：
   - 调整了命盘内部元素的样式，确保背景透明，避免影响整体视觉效果
   - 确保所有样式更改使用 `!important` 标记，以覆盖默认样式
   - 调整了深色模式下星耀的颜色，提高可读性：
     - 深紫色 → 亮黄色 (#ffff6b)，在灰色背景下更亮眼
     - 红色 → 亮红色 (#ff8080)
     - 绿色 → 亮绿色 (#80ff80)
     - 蓝色 → 亮蓝色 (#8080ff)

## 2026-02-21 深色模式重构

### 问题描述
- 深色模式下的样式更改没有生效，星耀颜色调整不明显
- 需要更彻底的深色模式重构，确保所有元素在深色背景下都清晰可见

### 技术实现
1. **重构深色模式切换逻辑**：
   - 将 'dark' 类从 document.documentElement 移到 document.body，以确保样式选择器正确匹配
   - 更新 toggleDarkMode 函数，操作 body 元素的 classList

2. **优化命盘样式**：
   - 为浅色模式下的命盘宫位添加半透明白色背景，提高对比度
   - 为深色模式下的命盘宫位使用更深的灰色背景 (#2d2d2d)，使文字和星耀更突出
   - 确保所有命盘内部元素的背景为透明，避免影响整体视觉效果

3. **增强星耀可读性**：
   - 使用 CSS filter: brightness(1.5) 提高深色模式下所有星耀的亮度
   - 特别为紫色星耀设置亮黄色 (#ffff6b) 并加粗，确保在深色背景下最亮眼
   - 调整其他颜色星耀为更亮的版本，提高在深色背景上的可见度

4. **改进样式选择器**：
   - 使用 `body.dark` 作为选择器前缀，确保样式在深色模式下正确应用
   - 为所有样式规则添加 `!important` 标记，确保覆盖默认样式

### 相关文件更改
- `frontend/tailwind.config.js`：添加了 `darkMode: 'class'` 配置
- `frontend/src/app/page.tsx`：
  - 实现了 `toggleDarkMode` 函数和切换按钮
  - 更新了 toggleDarkMode 函数，操作 body 元素的 classList
  - 重构了命盘样式，增强深色模式下的可读性
  - 改进了星耀颜色调整，确保在深色背景下清晰可见
- `frontend/src/components/BirthForm.tsx`：添加了深色模式支持

### 测试结果
- 深色模式切换功能正常工作
- 所有页面元素在深色模式下显示正确
- 命盘宫位的边框样式在深色模式下自动调整
- 切换按钮的图标会根据当前模式正确显示

### 后续计划
- 考虑添加系统主题自动检测功能，根据用户的系统主题偏好自动设置初始模式
- 优化深色模式下的对比度和可读性
- 添加更多主题选项，如高对比度模式等

## 2026-02-21 虚岁计算 bug 修复

### 问题描述
- 对于农历新年前出生的用户，虚岁计算错误，导致大限和流年计算不准确
- 例如：2000-1-4 出生的用户，5-14 岁大限应从 2003 年开始，但之前计算为 2004 年开始

### 技术实现
1. **核心逻辑修复**：
   - 在 `frontend/src/lib/shichen.ts` 中使用 `chinese-lunar-calendar` 库计算农历基准年
   - 重写 `getLunarBaseYear` 函数，通过库的方法获取准确的农历年份
   - 对于农历新年前出生的用户，自动返回正确的农历年份

2. **函数实现**：
   ```typescript
   export function getLunarBaseYear(solarDateStr: string): number {
     if (!solarDateStr) return new Date().getFullYear();
     
     const [year, month, day] = solarDateStr.split('-').map(Number);
     
     try {
       // 使用chinese-lunar-calendar库创建公历日期对象
       const solar = Solar.fromYmdHms(year, month, day, 0, 0, 0);
       
       // 获取农历日期对象
       const lunar = solar.getLunar();
       
       // 获取农历年份
       const lunarYear = lunar.getYear();
       
       console.log(`公历 ${solarDateStr} 对应的农历年份: ${lunarYear}`);
       
       return lunarYear;
     } catch (error) {
       console.error("计算农历基准年失败，降级为公历年:", error);
       return year;
     }
   }
   ```

3. **更新大限和流年计算**：
   - 在 `page.tsx` 中使用 `getLunarBaseYear` 计算农历基准年
   - 大限起始年份 = 农历基准年 + 起始虚岁 - 1
   - 动态生成流年按钮，确保大限范围内的年份正确
   - 修正流年虚岁计算逻辑，考虑出生当年可能为虚岁1岁或2岁的情况

### 测试结果
- 2000-1-4 出生的用户，农历基准年正确计算为 1999 年
- 5-14 岁大限起始年份正确计算为 2003 年（1999 + 5 - 1）
- 流年按钮显示正确的年份范围：2003-2012
- 使用 `chinese-lunar-calendar` 库确保了农历年份计算的准确性
- 解决了之前手动计算农历新年日期的复杂性问题

### 相关文件更改
- `frontend/src/lib/shichen.ts`：
  - 导入 `chinese-lunar-calendar` 库
  - 重写 `getLunarBaseYear` 函数，使用库的方法计算农历基准年
  - 实现 `getGregorianYearByNominalAge` 函数
- `frontend/src/app/page.tsx`：
  - 更新大限和流年计算逻辑
  - 添加调试日志，跟踪农历基准年和大限起始年份
  - 动态生成流年按钮，确保年份范围正确

---

## 2026-02-21 流年计算显示在 AI Prompt 中

### 功能描述
在 AI 命理师的提示词生成中，为每个宫位添加了流年虚岁信息的显示，使 AI 能够基于流年虚岁进行更准确的命理分析。

### 实现细节
- **文件**：`frontend/src/lib/ai.ts`
- **核心功能**：
  1. 添加了地支顺序数组 `EARTHLY_BRANCHES`，用于计算宫位位置差
  2. 实现了 `getPalaceMinorLimitAges` 函数，计算目标宫位的流年虚岁
  3. 从四柱中提取出生年地支，作为流年计算的基准
  4. 为每个宫位添加 "流年" 字段，显示前5个流年虚岁

### 技术原理
- 根据地支顺序计算宫位位置差（顺时针数）
- 首次流年虚岁 = 位置差 + 1
- 之后每12年循环一次，生成流年虚岁数组
- 在 AI Prompt 的数据上下文中显示流年虚岁信息

### 测试结果
- 庚辰年出生的用户，子宫的流年虚岁计算为：9, 21, 33, 45, 57
- 所有宫位的流年虚岁显示正确
- AI Prompt 中宫位信息包含完整的流年虚岁数据

---

## 2026-02-21 虚岁生年两岁特殊情况优化

### 问题描述
解决了生年虚岁为2岁时，大限与流年按钮不对应的问题。

### 原因分析
- **计算基准不一致**：大限选择按钮使用农历基准年计算，而查找当前大限时却使用公历出生年份
- **逻辑差异**：导致生年虚岁为2岁的情况下，大限和流年的计算结果不匹配

### 解决方案
- **文件**：`frontend/src/app/page.tsx`
- **核心修改**：
  1. 在查找当前大限时，使用与大限选择按钮相同的农历基准年
  2. 统一使用 `getGregorianYearByNominalAge` 函数计算大限年份范围
  3. 确保大限选择和流年显示的计算逻辑完全一致

### 测试结果
- 2000-01-04 出生的用户（生年虚岁2岁）：
  - 4-13 岁大限起始年份正确计算为 2002 年
  - 流年按钮显示正确的年份范围：2002-2011
  - 大限选择按钮与流年按钮对应关系正确
  - 其他年龄段的大限和流年按钮显示正常

### 技术改进
- 统一了大限和流年的计算基准，提高了系统的一致性
- 优化了生年虚岁特殊情况的处理，增强了系统的鲁棒性
- 减少了计算逻辑的差异，降低了维护成本